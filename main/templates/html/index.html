{% load static %}
<!DOCTYPE html>
<html lang="en">
  {% include 'views/header.html' %}
  <style>
    .carousel-item img {
      width: 100vh;
      max-height: 95vh;
      object-fit: contain;
      overflow: hidden;
    }
    .carousel-inner {
      padding: 0;
      margin: 0;
    }

    .carousel-item {
      position: relative;
    }
  </style>
  <body>
    {% include 'views/navbar.html' %}
    <!-- header -->
    <div
      id="carouselExampleAutoplaying"
      class="carousel slide"
      data-bs-ride="carousel"
      data-bs-interval="3000"
    >
      <div class="carousel-inner">
        <div class="carousel-item active">
          <img
            src="{% static 'img/img/bannertong1.png' %}"
            class="d-block w-100"
            alt="..."
          />
        </div>
        <div class="carousel-item">
          <img
            src="{% static 'img/img/bannertong2.png' %}"
            class="d-block w-100"
            alt="..."
          />
        </div>
        <div class="carousel-item">
          <img
            src="{% static 'img/img/bannertong3.png' %}"
            class="d-block w-100"
            alt="..."
          />
        </div>
      </div>
      <button
        class="carousel-control-prev"
        type="button"
        data-bs-target="#carouselExampleIndicators"
        data-bs-slide="prev"
      >
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button
        class="carousel-control-next"
        type="button"
        data-bs-target="#carouselExampleIndicators"
        data-bs-slide="next"
      >
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    </div>

    <!-- JavaScript v√† Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
    <div class="container main" style="margin-bottom: 200px">
      <div class="section">
        <img
          src="{% static '/img/img/Poster-You-Can-Do-It.png' %}"
          alt="Vi sao ban phai hoc tieng anh"
        />
        <div class="section-2">
          <h1 class="heading">
            <strong>Learn without limits and spread knowledge</strong>
          </h1>
          <br />
          <p class="doanvan">
            Kh√°m ph√° nh·ªØng c∆° h·ªôi m·ªõi v·ªõi c√°c kh√≥a h·ªçc, ch·ª©ng ch·ªâ v√† b·∫±ng c·∫•p t·ª´
            c√°c tr∆∞·ªùng ƒë·∫°i h·ªçc v√† doanh nghi·ªáp h√†ng ƒë·∫ßu. D√π b·∫°n mu·ªën thƒÉng ti·∫øn
            trong s·ª± nghi·ªáp, h·ªçc h·ªèi k·ªπ nƒÉng m·ªõi hay d·∫´n ƒë·∫ßu trong th·∫ø gi·ªõi c·∫°nh
            tranh, ch√∫ng t√¥i lu√¥n c√≥ t√†i nguy√™n ph√π h·ª£p cho b·∫°n. B·∫Øt ƒë·∫ßu h√†nh
            tr√¨nh c·ªßa b·∫°n ngay h√¥m nay!
          </p>
          <br />
          <div class="cta-group">
            <a href="#doraemon" class="signin" style="text-decoration: none"
              ><strong>See courses</strong></a
            >
            <button id="watch-video-btn" class="watch-video">
              <div class="icon">
                <img src="{% static 'img/icon/play-button.png' %}" alt="" />
              </div>
              <span><strong>Watch Video</strong></span>
            </button>
          </div>
          <!-- Popup video -->

          <!-- JavaScript -->
          <script>
            document.addEventListener("DOMContentLoaded", function () {
              const videoOverlay = document.getElementById("videoOverlay"); // videoOverlay id ph·∫ßn n·ªÅn ƒëen
              const videoFrame = document.getElementById("videoFrame"); // videoFrame id ph·∫ßn video
              const watchVideoButton =
                document.getElementById("watch-video-btn"); // ƒê·∫£m b·∫£o ƒë√∫ng ID n√∫t

              // Khi nh·∫•n "Watch Video", hi·ªÉn th·ªã popup & ph√°t video
              watchVideoButton.addEventListener("click", function () {
                videoOverlay.style.display = "flex"; // M·ªü popup
                videoFrame.play(); // B·∫Øt ƒë·∫ßu ph√°t
              });

              // Khi nh·∫•n ra ngo√†i popup, ƒë√≥ng popup & d·ª´ng video
              videoOverlay.addEventListener("click", function (event) {
                if (event.target === videoOverlay) {
                  videoOverlay.style.display = "none"; // ·∫®n popup
                  videoFrame.pause(); // D·ª´ng ph√°t video
                  videoFrame.currentTime = 0; // ƒê∆∞a v·ªÅ gi√¢y 0
                }
              });
            });
          </script>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6 text-start">
          <h2 id="doraemon"><strong>English for children</strong></h2>
          <br />
          <p class="doanvan">
            Ng√†y nay, ti·∫øng Anh ng√†y c√†ng tr·ªü n√™n quan tr·ªçng nh·ªù nh·ªØng l·ª£i √≠ch
            thi·∫øt th·ª±c m√† n√≥ mang l·∫°i trong h·ªçc t·∫≠p, c√¥ng vi·ªác v√† cu·ªôc s·ªëng.
            Nhi·ªÅu tr·∫ª em c√≥ th·ªÉ giao ti·∫øp ti·∫øng Anh tr√¥i ch·∫£y ngay t·ª´ nh·ªè, gi√∫p
            c√°c em t·ª± tin h∆°n v√† m·ªü ra nhi·ªÅu c∆° h·ªôi trong t∆∞∆°ng lai. Ch√∫ng t√¥i ·ªü
            ƒë√¢y ƒë·ªÉ ƒë·ªìng h√†nh c√πng con b·∫°n, gi√∫p c√°c em r√®n luy·ªán k·ªπ nƒÉng giao
            ti·∫øp ti·∫øng Anh m·ªôt c√°ch t·ª± nhi√™n v√† truy·ªÅn c·∫£m h·ª©ng ƒë·ªÉ c√°c em y√™u
            th√≠ch ng√¥n ng·ªØ n√†y h∆°n m·ªói ng√†y!
          </p>
          <br />
          <div class="chihuong">
            <img
              src="{% static 'img/icon/caimuiten.png' %}"
              alt=""
              class="arrow"
            />
            <a
              href="/Children_English"
              class="signin"
              style="text-decoration: none"
              ><strong>Enjoy this course</strong></a
            >
          </div>
        </div>
        <div class="col-md-6 text-end">
          <img
            src="{% static 'img/img/tr·∫ªconhocta.jpg' %}"
            alt="tr·∫ªconhocta"
            class="img-fluid ms-auto d-block"
          />
        </div>
      </div>
    </div>
    <!-- Aldult English -->
    <div class="container text-center aldult">
      <div class="row">
        <div class="col">
          <img
            src="{% static 'img/img/adultenglish.webp' %}"
            alt="M·∫•t g·ªëc c√≥ h·ªçc ƒë∆∞·ª£c ti·∫øng Anh ?"
          />
        </div>
        <div class="col">
          <h2><strong>Adult's English</strong></h2>
          <br />
          <p class="doanvan">
            B·∫°n ƒëang m·∫•t g·ªëc ti·∫øng Anh ho·∫∑c mong mu·ªën giao ti·∫øp t·ªët h∆°n ƒë·ªÉ l√†m
            vi·ªác v·ªõi ƒë·ªëi t√°c, thƒÉng ti·∫øn trong s·ª± nghi·ªáp? Nh∆∞ng b·∫°n e ng·∫°i khi
            h·ªçc ti·∫øng Anh v√¨ thi·∫øu th·ªùi gian v√† nhi·ªÅu l√Ω do kh√°c? H√£y tham gia
            ngay kh√≥a h·ªçc c·ªßa ch√∫ng t√¥i ‚Äì n∆°i gi√∫p b·∫°n h·ªçc ti·∫øng Anh d·ªÖ d√†ng,
            linh ho·∫°t theo l·ªãch tr√¨nh c·ªßa ri√™ng m√¨nh. ƒê·ª´ng ch·∫ßn ch·ª´, b·∫Øt ƒë·∫ßu
            ngay h√¥m nay v√† ƒë·ªìng h√†nh c√πng ch√∫ng t√¥i!
          </p>
          <br />
          <div class="chihuong">
            <img
              src="{% static 'img/icon/caimuiten.png' %}"
              alt="M≈©i t√™n"
              class="arrow"
            />
            <a
              href="/Adult_English"
              class="signin"
              style="text-decoration: none"
              ><strong>Enjoy this course</strong></a
            >
          </div>
        </div>
      </div>
    </div>
    <div class="container ielts-exam">
      <div class="row align-items-center">
        <div class="col-md-6 text-start">
          <h2><strong>Ielts Exam</strong></h2>
          <br />
          <p class="doanvan">
            Ch√∫ng t√¥i cung c·∫•p b·ªô ƒë·ªÅ thi tham kh·∫£o IELTS ch·∫•t l∆∞·ª£ng, b√°m s√°t c·∫•u
            tr√∫c ƒë·ªÅ thi th·∫≠t, gi√∫p b·∫°n r√®n luy·ªán k·ªπ nƒÉng v√† l√†m quen v·ªõi √°p l·ª±c
            th·ªùi gian. V·ªõi h·ªá th·ªëng ƒë·ªÅ thi ƒëa d·∫°ng, c·∫≠p nh·∫≠t th∆∞·ªùng xuy√™n theo
            xu h∆∞·ªõng m·ªõi nh·∫•t, b·∫°n s·∫Ω c√≥ c∆° h·ªôi th·ª±c h√†nh hi·ªáu qu·∫£ c·∫£ b·ªën k·ªπ
            nƒÉng: Nghe, N√≥i, ƒê·ªçc, Vi·∫øt. Luy·ªán t·∫≠p v·ªõi b·ªô ƒë·ªÅ c·ªßa ch√∫ng t√¥i s·∫Ω
            gi√∫p b·∫°n c·∫£i thi·ªán chi·∫øn l∆∞·ª£c l√†m b√†i, n√¢ng cao s·ª± t·ª± tin v√† s·∫µn
            s√†ng chinh ph·ª•c k·ª≥ thi IELTS!
          </p>
          <br />
          <div class="chihuong">
            <img
              src="{% static 'img/icon/caimuiten.png' %}"
              alt=""
              class="arrow"
            />
            <a
              href="./Children_English"
              class="signin"
              style="text-decoration: none"
              ><strong>Check now</strong></a
            >
          </div>
        </div>
        <div class="col-md-6 text-end">
          <img
            src="{% static 'img/img/ielts-exam.png' %}"
            alt="tr·∫ªconhocta"
            class="img-fluid ms-auto d-block"
          />
        </div>
      </div>
    </div>
    <!-- ====== Placement Test (ƒë√°nh gi√° tr√¨nh ƒë·ªô) tr∆∞·ªõc footer ====== -->
    <div class="container" style="margin: 60px auto 100px auto">
      <div id="placement-test" style="max-width: 900px; margin: 0 auto">
        <h2 style="text-align: center">
          <strong>Placement Test - ƒê√°nh gi√° tr√¨nh ƒë·ªô</strong>
        </h2>
        <p style="text-align: center">
          L√†m nhanh b√†i test d∆∞·ªõi ƒë√¢y ƒë·ªÉ NAK ENGLISH g·ª£i √Ω l·ªô tr√¨nh h·ªçc ph√π h·ª£p.
        </p>

        <div id="placement-intro" style="text-align: center">
          <button
            id="placement-start"
            style="
              padding: 12px 24px;
              font-size: 16px;
              border: none;
              border-radius: 6px;
              background: #3498db;
              color: white;
              cursor: pointer;
            "
          >
            B·∫Øt ƒë·∫ßu l√†m b√†i
          </button>
        </div>

        <div id="placement-quiz" style="display: none">
          <div
            id="placement-progress"
            style="margin: 10px 0; font-weight: 600"
          ></div>
          <div
            id="placement-question"
            style="font-size: 18px; margin: 10px 0"
          ></div>
          <div id="placement-options" style="display: grid; gap: 10px"></div>
          <div style="margin-top: 16px; display: flex; gap: 10px">
            <button
              id="placement-next"
              style="
                padding: 10px 18px;
                border: none;
                border-radius: 6px;
                background: #4caf50;
                color: white;
                cursor: pointer;
              "
            >
              C√¢u ti·∫øp theo ‚ñ∂
            </button>
            <button
              id="placement-submit"
              style="
                display: none;
                padding: 10px 18px;
                border: none;
                border-radius: 6px;
                background: #e67e22;
                color: white;
                cursor: pointer;
              "
            >
              N·ªôp b√†i ‚úÖ
            </button>
          </div>
          <div
            id="placement-error"
            style="color: #e74c3c; margin-top: 8px; display: none"
          >
            Vui l√≤ng ch·ªçn m·ªôt ƒë√°p √°n.
          </div>
        </div>

        <div
          id="placement-result"
          style="display: none; text-align: center; margin-top: 16px"
        ></div>
      </div>
    </div>

    <!-- them anh cho dep -->
    <!-- footer  -->
    {% include 'views/footer.html' %}
  </body>
  <div class="video-popup" id="videoOverlay" style="display: none">
    <div class="video-container">
      <video id="videoFrame" width="100%" height="100%" controls>
        <source
          src="{% static 'video/videonakenglish.mp4' %}"
          type="video/mp4"
        />
        Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.
      </video>
    </div>
  </div>
</html>
<style>
  body {
    margin: 0;
    font-family: "Roboto", sans-serif;
    background-color: #f5f7fa;
  }

  /* Container cho chatbot */
  .chatbot-container {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
  }

  /* N√∫t chatbot */
  .chatbot-button {
    width: 70px;
    height: 70px;
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    font-size: 28px;
    animation: pulse 2s infinite;
  }

  .chatbot-button:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
  }

  /* Hi·ªáu ·ª©ng pulse */
  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(234, 116, 225, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
    }
  }

  /* Khung chat */
  .chatbot-window {
    width: 350px;
    height: 500px;
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    display: none;
    flex-direction: column;
    position: absolute;
    bottom: 100px;
    right: 0;
    overflow: hidden;
    transform: scale(0.8);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }

  /* N√∫t li√™n k·∫øt trong chatbot */
  .chatbot-link-btn {
    display: inline-block;
    margin-top: 8px;
    padding: 8px 14px;
    background: linear-gradient(to right, #58c46b, #3498db);
    color: #fff;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    text-decoration: none;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.2s ease;
  }

  .chatbot-link-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    opacity: 0.95;
  }

  .chatbot-container.active .chatbot-window {
    display: flex;
    transform: scale(1);
    opacity: 1;
  }

  /* Header khung chat */
  .chatbot-header {
    font-family: "Honk", sans-serif;
    background: linear-gradient(to right, rgb(143, 227, 161), #3498db);
    color: black;
    padding: 15px;
    text-align: center;
    font-size: 36px;
    font-weight: 500;
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
  }

  /* N·ªôi dung khung chat */
  .chatbot-body {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #f0f4ff;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* Tin nh·∫Øn */
  .message {
    padding: 10px 15px;
    border-radius: 15px;
    max-width: 75%;
    line-height: 1.4;
    animation: slideIn 0.3s ease;
    white-space: pre-wrap; /* H·ªó tr·ª£ xu·ªëng d√≤ng */
  }

  .message.user {
    background: pink;
    color: black;
    margin-left: auto;
    border-bottom-right-radius: 5px;
  }

  .message.bot {
    background: #e9ecef;
    color: #333;
    margin-right: auto;
    border-bottom-left-radius: 5px;
  }

  /* Hi·ªáu ·ª©ng tin nh·∫Øn xu·∫•t hi·ªán */
  @keyframes slideIn {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Footer ch·ª©a input */
  .chatbot-footer {
    padding: 15px;
    background: #fff;
    border-top: 1px solid #e0e0e0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .chatbot-footer input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 25px;
    outline: none;
    font-size: 14px;
    transition: border-color 0.3s ease;
  }

  .chatbot-footer input:focus {
    border-color: linear-gradient(to right, rgb(143, 227, 161), #3498db);
  }

  .chatbot-footer button {
    padding: 12px;
    background: linear-gradient(to right, rgb(143, 227, 161), #3498db);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s ease;
  }

  .chatbot-footer button:hover {
    background: linear-gradient(to right, rgb(143, 227, 161), #3498db);
  }

  .chatbot-button img {
    width: 70px;
    height: 70px;
    object-fit: contain;
    border-radius: 50%;
  }

  /* Responsive */
  @media (max-width: 480px) {
    .chatbot-window {
      width: 90vw;
      height: 80vh;
      bottom: 80px;
      right: 10px;
    }

    .chatbot-button {
      width: 60px;
      height: 60px;
      font-size: 24px;
    }
  }
</style>
<div class="chatbot-container">
  <div class="chatbot-button">
    <img
      src="{% static 'img/img/479374583_2408177479537942_8679824344704556172_n (1).png' %}"
      alt="logooo"
      class="loggonak"
      style=""
    />
  </div>
  <div class="chatbot-window">
    <div class="chatbot-header">NAK ENGLISH</div>
    <div class="chatbot-body" id="chatbot-body">
      <div class="message bot" style="white-space: normal">
        <strong>Xin ch√†o! C√πng h·ªçc t·∫≠p v·ªõi NAK ENGLISH nh√© üôÇ</strong>
      </div>
    </div>
    <div class="chatbot-footer">
      <input
        type="text"
        id="user-input"
        placeholder="Nh·∫≠p c√¢u ho·∫∑c c√¢u h·ªèi..."
      />
      <button onclick="sendMessage()">üì§</button>
    </div>
  </div>
</div>

<script>
  const API_KEY = "AIzaSyCWS6sP5S9ij4mOK-xnq6s8piEnFLsKz-g";
  const API_URL =
    "generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";

  const SYSTEM_PROMPT = `H√£y ƒë√≥ng vai l√† m·ªôt gi√°o vi√™n ti·∫øng Anh chuy√™n nghi·ªáp, th√¢n thi·ªán v√† ki√™n nh·∫´n, v·ªõi nhi·ªám v·ª• ch√≠nh l√† gi√∫p t√¥i h·ªçc ti·∫øng Anh. Khi t√¥i ƒë∆∞a ra m·ªôt t·ª´ v·ª±ng (ho·∫∑c h·ªèi nghƒ©a c·ªßa m·ªôt t·ª´), b·∫°n ph·∫£i ngay l·∫≠p t·ª©c gi·∫£i th√≠ch r√µ r√†ng t·ª´ lo·∫°i, nghƒ©a ti·∫øng Vi·ªát c·ªßa n√≥, v√† cung c·∫•p m·ªôt v√†i c√¢u v√≠ d·ª• ti·∫øng Anh ƒë·ªÉ minh h·ªça c√°ch d√πng. Trong tr∆∞·ªùng h·ª£p t√¥i ƒë∆∞a ra m·ªôt c√¢u ti·∫øng Anh ho√†n ch·ªânh, b·∫°n ph·∫£i ph√¢n t√≠ch ng·ªØ ph√°p c·ªßa c√¢u ƒë√≥. N·∫øu c√¢u c√≥ l·ªói sai, b·∫°n c·∫ßn ch·ªâ r√µ l·ªói, gi·∫£i th√≠ch t·∫°i sao n√≥ sai (v·ªÅ th√¨, gi·ªõi t·ª´, c·∫•u tr√∫c, v.v.), v√† cung c·∫•p phi√™n b·∫£n ƒë√£ ƒë∆∞·ª£c s·ª≠a ch·ªØa ch√≠nh x√°c. N·∫øu c√¢u ƒë√£ ho√†n to√†n ƒë√∫ng ng·ªØ ph√°p, b·∫°n ch·ªâ c·∫ßn x√°c nh·∫≠n r·∫±ng c√¢u ƒë√≥ ƒë√∫ng (v√≠ d·ª•: "C√¢u n√†y ƒë√∫ng! üëç") v√† b·ªè qua, kh√¥ng c·∫ßn ph√¢n t√≠ch g√¨ th√™m. H√£y lu√¥n gi·ªØ gi·ªçng ƒëi·ªáu khuy·∫øn kh√≠ch v√† ch·ªâ t·∫≠p trung v√†o vi·ªác gi·∫£ng d·∫°y ti·∫øng Anh. H√£y b·∫Øt ƒë·∫ßu.`;

  document.querySelector(".chatbot-button").addEventListener("click", () => {
    document.querySelector(".chatbot-container").classList.toggle("active");
    // Khi m·ªü chatbot, t·ª± ƒë·ªông t·∫£i khuy·∫øn ngh·ªã g·∫ßn nh·∫•t (ch·ªâ 1 l·∫ßn m·ªói l·∫ßn m·ªü)
    const container = document.querySelector(".chatbot-container");
    const justOpened = container.classList.contains("active");
    if (justOpened) {
      fetchLatestRecommendation();
    }
  });

  async function sendMessage() {
    const input = document.getElementById("user-input");
    const message = input.value.trim();
    if (!message) return;

    // Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
    const chatBody = document.getElementById("chatbot-body");
    const userMessage = document.createElement("div");
    userMessage.className = "message user";
    userMessage.textContent = message;
    chatBody.appendChild(userMessage);
    input.value = "";

    // Cu·ªôn xu·ªëng cu·ªëi
    chatBody.scrollTop = chatBody.scrollHeight;

    try {
      console.log("G·ª≠i request ƒë·∫øn Gemini API:", message);

      // G·ª≠i y√™u c·∫ßu ƒë·∫øn Gemini API
      const response = await fetch("/api/generate/", {
        headers: {
          app_id: "YOUR_APP_ID", // C·∫ßn th√™m app_id cho Oxford API
          app_key: API_KEY,
        },
      });

      console.log("Response status:", response.status);

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(
          `L·ªói khi g·ªçi Gemini API: ${response.status} - ${errorText}`
        );
      }

      const responseText = await response.text();
      console.log("Raw response:", responseText.substring(0, 200));

      let data;
      try {
        data = JSON.parse(responseText);
        console.log("Parsed data:", data);
      } catch (parseError) {
        throw new Error(
          `Kh√¥ng th·ªÉ parse JSON: ${responseText.substring(0, 100)}...`
        );
      }

      // Ki·ªÉm tra response format an to√†n h∆°n
      if (!data.candidates || data.candidates.length === 0) {
        throw new Error(
          `Kh√¥ng c√≥ candidates trong response: ${JSON.stringify(data)}`
        );
      }

      const candidate = data.candidates[0];
      if (
        !candidate ||
        !candidate.content ||
        !candidate.content.parts ||
        candidate.content.parts.length === 0
      ) {
        throw new Error(
          `Format candidate kh√¥ng ƒë√∫ng: ${JSON.stringify(candidate)}`
        );
      }

      const botReply = candidate.content.parts[0].text;

      // Hi·ªÉn th·ªã ph·∫£n h·ªìi c·ªßa bot
      const botMessage = document.createElement("div");
      botMessage.className = "message bot";
      botMessage.textContent = botReply;
      chatBody.appendChild(botMessage);

      // Cu·ªôn xu·ªëng cu·ªëi
      chatBody.scrollTop = chatBody.scrollHeight;
    } catch (error) {
      const errorMessage = document.createElement("div");
      errorMessage.className = "message bot";

      // Fallback response n·∫øu API l·ªói
      const fallbackResponse = `Xin l·ªói, t√¥i ƒëang g·∫∑p s·ª± c·ªë k·ªπ thu·∫≠t. Tuy nhi√™n, t√¥i v·∫´n c√≥ th·ªÉ gi√∫p b·∫°n:

  - H·ªçc t·ª´ v·ª±ng c∆° b·∫£n: Hello, Goodbye, Thank you
  - Ng·ªØ ph√°p ƒë∆°n gi·∫£n: I am, You are, He/She is
  - C√¢u giao ti·∫øp: How are you? What's your name?

  B·∫°n c√≥ th·ªÉ th·ª≠ l·∫°i sau ho·∫∑c li√™n h·ªá admin ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.`;

      errorMessage.textContent = fallbackResponse;
      chatBody.appendChild(errorMessage);
      console.error("Chatbot API Error:", error);
    }
  }

  // G·ª≠i tin nh·∫Øn khi nh·∫•n Enter
  document.getElementById("user-input").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      sendMessage();
    }
  });

  // ====== Helpers: hi·ªÉn th·ªã v√† t√≠ch h·ª£p API k·∫øt qu·∫£ b√†i test ======
  function appendBotMessage(text) {
    const chatBody = document.getElementById("chatbot-body");
    const botMessage = document.createElement("div");
    botMessage.className = "message bot";
    botMessage.textContent = text;
    chatBody.appendChild(botMessage);
    chatBody.scrollTop = chatBody.scrollHeight;

    // T·ª± ƒë·ªông m·ªü c·ª≠a s·ªï chatbot khi c√≥ tin nh·∫Øn t∆∞ v·∫•n
    const container = document.querySelector(".chatbot-container");
    if (!container.classList.contains("active")) {
      container.classList.add("active");
    }
  }

  function appendBotHTML(html) {
    const chatBody = document.getElementById("chatbot-body");
    const botMessage = document.createElement("div");
    botMessage.className = "message bot";
    botMessage.innerHTML = html;
    chatBody.appendChild(botMessage);
    chatBody.scrollTop = chatBody.scrollHeight;

    const container = document.querySelector(".chatbot-container");
    if (!container.classList.contains("active")) {
      container.classList.add("active");
    }
  }

  // G·ªçi khi ng∆∞·ªùi d√πng ho√†n th√†nh b√†i test ·ªü frontend c·ªßa b·∫°n
  // V√≠ d·ª•: postTestResult(72, 'K·∫øt qu·∫£ ph·∫ßn Vocabulary ƒë√∫ng 18/25')
  async function postTestResult(score, details = "") {
    try {
      console.log("G·ª≠i k·∫øt qu·∫£ test:", { score, details });

      const res = await fetch("/api/test-result", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ score, details }),
      });

      console.log("Response status:", res.status);

      if (!res.ok) {
        const errorText = await res.text();
        console.error("API Error:", errorText);
        appendBotMessage(`G·ª≠i ƒëi·ªÉm th·∫•t b·∫°i (${res.status}): ${errorText}`);
        return;
      }

      const data = await res.json();
      console.log("API Response:", data);

      if (data.target_url && data.target_label) {
        appendBotHTML(
          `K·∫øt qu·∫£ c·ªßa b·∫°n: <b>${data.score}</b>%<br/>` +
            `Tr√¨nh ƒë·ªô g·ª£i √Ω: <b>${data.level}</b><br/>` +
            `H∆∞·ªõng d·∫´n h·ªçc: ${data.recommendation}<br/>` +
            `<a href="${data.target_url}" class="chatbot-link-btn">${data.target_label}</a>`
        );
      } else {
        appendBotMessage(
          `K·∫øt qu·∫£ c·ªßa b·∫°n: ${data.score}.\nTr√¨nh ƒë·ªô g·ª£i √Ω: ${data.level}.\nH∆∞·ªõng d·∫´n h·ªçc: ${data.recommendation}`
        );
      }
    } catch (err) {
      console.error("Test result error:", err);
      appendBotMessage(
        `C√≥ l·ªói x·∫£y ra khi g·ª≠i k·∫øt qu·∫£ b√†i test: ${err.message}`
      );
    }
  }

  // T·ª± ƒë·ªông l·∫•y khuy·∫øn ngh·ªã g·∫ßn nh·∫•t khi m·ªü chatbot
  async function fetchLatestRecommendation() {
    try {
      const res = await fetch("/api/recommendation");
      if (!res.ok) return; // kh√¥ng c√≥ d·ªØ li·ªáu th√¨ b·ªè qua
      const data = await res.json();
      if (data.target_url && data.target_label) {
        appendBotHTML(
          `Khuy·∫øn ngh·ªã g·∫ßn nh·∫•t c·ªßa b·∫°n: <b>${data.level}</b><br/>` +
            `G·ª£i √Ω h·ªçc: ${data.recommendation}<br/>` +
            `<a href="${data.target_url}" class="chatbot-link-btn">${data.target_label}</a>`
        );
      } else {
        appendBotMessage(
          `Khuy·∫øn ngh·ªã g·∫ßn nh·∫•t c·ªßa b·∫°n: ${data.level}.\nG·ª£i √Ω h·ªçc: ${data.recommendation}`
        );
      }
    } catch (err) {
      console.error(err);
    }
  }
</script>

<!-- ====== Placement Test (ƒë√°nh gi√° tr√¨nh ƒë·ªô) ·ªü cu·ªëi trang ====== -->
<!-- Removed duplicate placement test block (kept the one before footer) -->

<script>
  (function () {
    // 10 c√¢u h·ªèi tr·ªôn k·ªπ nƒÉng c∆° b·∫£n
    const questions = [
      {
        q: "Ch·ªçn c√¢u ch√†o h·ªèi ƒë√∫ng:",
        opts: ["Nice meet you", "Nice to meet you", "You nice to meet"],
        correct: 1,
      },
      {
        q: "T·ª´ n√†o l√† danh t·ª´ ch·ªâ ƒë·ªì v·∫≠t?",
        opts: ["Run", "Table", "Quickly"],
        correct: 1,
      },
      {
        q: "Ch·ªçn th√¨ hi·ªán t·∫°i ƒë∆°n ƒë√∫ng:",
        opts: ["He go to school", "He goes to school", "He going to school"],
        correct: 1,
      },
      {
        q: "T√≠nh t·ª´ c·ªßa 'success' l√†:",
        opts: ["successful", "successfully", "successes"],
        correct: 0,
      },
      {
        q: "D·∫°ng ƒë√∫ng c·ªßa ƒë·ªông t·ª´: 'She ____ English every day.'",
        opts: ["study", "studies", "studied"],
        correct: 1,
      },
      {
        q: "T·ª´ ƒë·ªìng nghƒ©a g·∫ßn v·ªõi 'happy':",
        opts: ["sad", "glad", "angry"],
        correct: 1,
      },
      {
        q: "ƒêi·ªÅn m·∫°o t·ª´ ƒë√∫ng: 'I have ____ apple.'",
        opts: ["a", "an", "the"],
        correct: 1,
      },
      {
        q: "C√¢u h·ªèi ƒë√∫ng ng·ªØ ph√°p:",
        opts: [
          "What time you get up?",
          "What time do you get up?",
          "You get up what time?",
        ],
        correct: 1,
      },
      {
        q: "'children' l√† s·ªë nhi·ªÅu c·ªßa:",
        opts: ["child", "chill", "chile"],
        correct: 0,
      },
      {
        q: "Ch·ªçn gi·ªõi t·ª´ ƒë√∫ng: 'I am interested ____ music.'",
        opts: ["on", "in", "at"],
        correct: 1,
      },
    ];

    const introEl = document.getElementById("placement-intro");
    const quizEl = document.getElementById("placement-quiz");
    const progressEl = document.getElementById("placement-progress");
    const questionEl = document.getElementById("placement-question");
    const optionsEl = document.getElementById("placement-options");
    const nextBtn = document.getElementById("placement-next");
    const submitBtn = document.getElementById("placement-submit");
    const errorEl = document.getElementById("placement-error");
    const resultEl = document.getElementById("placement-result");

    let index = 0;
    let score = 0;
    const answers = [];

    function renderQuestion() {
      errorEl.style.display = "none";
      const current = questions[index];
      progressEl.textContent = `C√¢u ${index + 1} / ${questions.length}`;
      questionEl.textContent = current.q;
      optionsEl.innerHTML = "";
      current.opts.forEach((opt, i) => {
        const id = `opt-${index}-${i}`;
        const label = document.createElement("label");
        label.style.display = "flex";
        label.style.gap = "8px";
        label.style.alignItems = "center";
        label.innerHTML = `<input type="radio" name="q-${index}" value="${i}" id="${id}" /> <span>${opt}</span>`;
        optionsEl.appendChild(label);
      });

      // Toggle n√∫t
      const isLast = index === questions.length - 1;
      nextBtn.style.display = isLast ? "none" : "inline-block";
      submitBtn.style.display = isLast ? "inline-block" : "none";
    }

    function getSelectedIndex() {
      const radios = optionsEl.querySelectorAll('input[type="radio"]');
      for (const r of radios) {
        if (r.checked) return parseInt(r.value, 10);
      }
      return null;
    }

    function onAnswer(nextStep) {
      const sel = getSelectedIndex();
      if (sel === null) {
        errorEl.style.display = "block";
        return;
      }
      answers[index] = sel;
      if (sel === questions[index].correct) score += 1;
      nextStep();
    }

    function showResult() {
      quizEl.style.display = "none";
      const pct = Math.round((score / questions.length) * 100);
      resultEl.style.display = "block";
      resultEl.innerHTML = `<h3>K·∫øt qu·∫£ c·ªßa b·∫°n: ${score}/${questions.length} (${pct}%)</h3><p>Chatbot ƒëang t∆∞ v·∫•n l·ªô tr√¨nh d·ª±a tr√™n k·∫øt qu·∫£ c·ªßa b·∫°n...</p>`;

      // G·ª≠i v·ªÅ server ƒë·ªÉ l∆∞u + sinh khuy·∫øn ngh·ªã, chatbot s·∫Ω hi·ªÉn th·ªã ph·∫£n h·ªìi
      if (typeof postTestResult === "function") {
        postTestResult(
          pct,
          `Placement Test: ƒë√∫ng ${score}/${questions.length}`
        );
      }
    }

    document.getElementById("placement-start").addEventListener("click", () => {
      introEl.style.display = "none";
      quizEl.style.display = "block";
      index = 0;
      score = 0;
      answers.length = 0;
      renderQuestion();
    });

    nextBtn.addEventListener("click", () => {
      onAnswer(() => {
        index += 1;
        renderQuestion();
      });
    });

    submitBtn.addEventListener("click", () => {
      onAnswer(() => {
        showResult();
      });
    });
  })();
</script>
